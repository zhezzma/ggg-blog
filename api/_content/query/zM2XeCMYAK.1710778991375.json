{"_path":"/dotnet/2020-12-11-chrome-login-fail","_dir":"dotnet","_draft":false,"_partial":false,"_locale":"","title":"谷歌浏览器下netcore登录失败问题","description":"IntroductionWhen you use HTTP on your Identity Server 4 enabled website, users may not login because of the changes made by Chrome in the version 8x. This occurs when you use HTTP schema in your website. The issue is explained here https://docs.microsoft.com/en-gb/dotnet/core/compatibility/3.0-3.1#h","body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"introduction"},"children":[{"type":"text","value":"Introduction"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you use HTTP on your Identity Server 4 enabled website, users may not login because of the changes made by Chrome in the version 8x. This occurs when you use HTTP schema in your website. The issue is explained here "},{"type":"element","tag":"a","props":{"href":"https://docs.microsoft.com/en-gb/dotnet/core/compatibility/3.0-3.1#http-browser-samesite-changes-impact-authentication","rel":["nofollow"]},"children":[{"type":"text","value":"https://docs.microsoft.com/en-gb/dotnet/core/compatibility/3.0-3.1#http-browser-samesite-changes-impact-authentication"}]}]},{"type":"element","tag":"h2","props":{"id":"how-to-solve-it"},"children":[{"type":"text","value":"How to solve it?"}]},{"type":"element","tag":"h3","props":{"id":"step-1"},"children":[{"type":"text","value":"Step-1"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Create the below extension in your *"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":".Web"}]},{"type":"text","value":" project."}]},{"type":"element","tag":"pre","props":{"className":["language-csharp"],"code":"using System;\nusing Microsoft.AspNetCore.Builder;\nusing Microsoft.AspNetCore.Http;\n\nnamespace Microsoft.Extensions.DependencyInjection\n{\n    public static class SameSiteCookiesServiceCollectionExtensions\n    {\n        /// <summary>\n        /// -1 defines the unspecified value, which tells ASPNET Core to NOT\n        /// send the SameSite attribute. With ASPNET Core 3.1 the\n        /// <seealso cref=\"SameSiteMode\" /> enum will have a definition for\n        /// Unspecified.\n        /// </summary>\n        private const SameSiteMode Unspecified = (SameSiteMode)(-1);\n\n        /// <summary>\n        /// Configures a cookie policy to properly set the SameSite attribute\n        /// for Browsers that handle unknown values as Strict. Ensure that you\n        /// add the <seealso cref=\"Microsoft.AspNetCore.CookiePolicy.CookiePolicyMiddleware\" />\n        /// into the pipeline before sending any cookies!\n        /// </summary>\n        /// <remarks>\n        /// Minimum ASPNET Core Version required for this code:\n        ///   - 2.1.14\n        ///   - 2.2.8\n        ///   - 3.0.1\n        ///   - 3.1.0-preview1\n        /// Starting with version 80 of Chrome (to be released in February 2020)\n        /// cookies with NO SameSite attribute are treated as SameSite=Lax.\n        /// In order to always get the cookies send they need to be set to\n        /// SameSite=None. But since the current standard only defines Lax and\n        /// Strict as valid values there are some browsers that treat invalid\n        /// values as SameSite=Strict. We therefore need to check the browser\n        /// and either send SameSite=None or prevent the sending of SameSite=None.\n        /// Relevant links:\n        /// - https://tools.ietf.org/html/draft-west-first-party-cookies-07#section-4.1\n        /// - https://tools.ietf.org/html/draft-west-cookie-incrementalism-00\n        /// - https://www.chromium.org/updates/same-site\n        /// - https://devblogs.microsoft.com/aspnet/upcoming-samesite-cookie-changes-in-asp-net-and-asp-net-core/\n        /// - https://bugs.webkit.org/show_bug.cgi?id=198181\n        /// </remarks>\n        /// <param name=\"services\">The service collection to register <see cref=\"CookiePolicyOptions\" /> into.</param>\n        /// <returns>The modified <see cref=\"IServiceCollection\" />.</returns>\n        public static IServiceCollection ConfigureNonBreakingSameSiteCookies(this IServiceCollection services)\n        {\n            services.Configure<CookiePolicyOptions>(options =>\n            {\n                options.MinimumSameSitePolicy = Unspecified;\n                options.OnAppendCookie = cookieContext =>\n                CheckSameSite(cookieContext.Context, cookieContext.CookieOptions);\n                options.OnDeleteCookie = cookieContext =>\n                CheckSameSite(cookieContext.Context, cookieContext.CookieOptions);\n            });\n\n            return services;\n        }\n\n        private static void CheckSameSite(HttpContext httpContext, CookieOptions options)\n        {\n            if (options.SameSite == SameSiteMode.None)\n            {\n                var userAgent = httpContext.Request.Headers[\"User-Agent\"].ToString();\n\n                if (DisallowsSameSiteNone(userAgent))\n                {\n                    options.SameSite = Unspecified;\n                }\n            }\n        }\n\n        /// <summary>\n        /// Checks if the UserAgent is known to interpret an unknown value as Strict.\n        /// For those the <see cref=\"CookieOptions.SameSite\" /> property should be\n        /// set to <see cref=\"Unspecified\" />.\n        /// </summary>\n        /// <remarks>\n        /// This code is taken from Microsoft:\n        /// https://devblogs.microsoft.com/aspnet/upcoming-samesite-cookie-changes-in-asp-net-and-asp-net-core/\n        /// </remarks>\n        /// <param name=\"userAgent\">The user agent string to check.</param>\n        /// <returns>Whether the specified user agent (browser) accepts SameSite=None or not.</returns>\n        private static bool DisallowsSameSiteNone(string userAgent)\n        {\n            // Cover all iOS based browsers here. This includes:\n            //   - Safari on iOS 12 for iPhone, iPod Touch, iPad\n            //   - WkWebview on iOS 12 for iPhone, iPod Touch, iPad\n            //   - Chrome on iOS 12 for iPhone, iPod Touch, iPad\n            // All of which are broken by SameSite=None, because they use the\n            // iOS networking stack.\n            // Notes from Thinktecture:\n            // Regarding https://caniuse.com/#search=samesite iOS versions lower\n            // than 12 are not supporting SameSite at all. Starting with version 13\n            // unknown values are NOT treated as strict anymore. Therefore we only\n            // need to check version 12.\n            if (userAgent.Contains(\"CPU iPhone OS 12\")\n               || userAgent.Contains(\"iPad; CPU OS 12\"))\n            {\n                return true;\n            }\n\n            // Cover Mac OS X based browsers that use the Mac OS networking stack.\n            // This includes:\n            //   - Safari on Mac OS X.\n            // This does not include:\n            //   - Chrome on Mac OS X\n            // because they do not use the Mac OS networking stack.\n            // Notes from Thinktecture:\n            // Regarding https://caniuse.com/#search=samesite MacOS X versions lower\n            // than 10.14 are not supporting SameSite at all. Starting with version\n            // 10.15 unknown values are NOT treated as strict anymore. Therefore we\n            // only need to check version 10.14.\n            if (userAgent.Contains(\"Safari\")\n               && userAgent.Contains(\"Macintosh; Intel Mac OS X 10_14\")\n               && userAgent.Contains(\"Version/\"))\n            {\n                return true;\n            }\n\n            // Cover Chrome 50-69, because some versions are broken by SameSite=None\n            // and none in this range require it.\n            // Note: this covers some pre-Chromium Edge versions,\n            // but pre-Chromium Edge does not require SameSite=None.\n            // Notes from Thinktecture:\n            // We can not validate this assumption, but we trust Microsofts\n            // evaluation. And overall not sending a SameSite value equals to the same\n            // behavior as SameSite=None for these old versions anyways.\n            if (userAgent.Contains(\"Chrome/5\") || userAgent.Contains(\"Chrome/6\"))\n            {\n                return true;\n            }\n\n            if (GetChromeVersion(userAgent) >= 80)\n            {\n                return true;\n            }\n\n            return false;\n        }\n\n        private static int GetChromeVersion(string userAgent)\n        {\n            try\n            {\n                return Convert.ToInt32(userAgent.Split(\"Chrome/\")[1].Split('.')[0]);\n            }\n            catch (Exception)\n            {\n                return 0;\n            }\n        }\n    }\n}\n","language":"csharp","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"using System;\nusing Microsoft.AspNetCore.Builder;\nusing Microsoft.AspNetCore.Http;\n\nnamespace Microsoft.Extensions.DependencyInjection\n{\n    public static class SameSiteCookiesServiceCollectionExtensions\n    {\n        /// <summary>\n        /// -1 defines the unspecified value, which tells ASPNET Core to NOT\n        /// send the SameSite attribute. With ASPNET Core 3.1 the\n        /// <seealso cref=\"SameSiteMode\" /> enum will have a definition for\n        /// Unspecified.\n        /// </summary>\n        private const SameSiteMode Unspecified = (SameSiteMode)(-1);\n\n        /// <summary>\n        /// Configures a cookie policy to properly set the SameSite attribute\n        /// for Browsers that handle unknown values as Strict. Ensure that you\n        /// add the <seealso cref=\"Microsoft.AspNetCore.CookiePolicy.CookiePolicyMiddleware\" />\n        /// into the pipeline before sending any cookies!\n        /// </summary>\n        /// <remarks>\n        /// Minimum ASPNET Core Version required for this code:\n        ///   - 2.1.14\n        ///   - 2.2.8\n        ///   - 3.0.1\n        ///   - 3.1.0-preview1\n        /// Starting with version 80 of Chrome (to be released in February 2020)\n        /// cookies with NO SameSite attribute are treated as SameSite=Lax.\n        /// In order to always get the cookies send they need to be set to\n        /// SameSite=None. But since the current standard only defines Lax and\n        /// Strict as valid values there are some browsers that treat invalid\n        /// values as SameSite=Strict. We therefore need to check the browser\n        /// and either send SameSite=None or prevent the sending of SameSite=None.\n        /// Relevant links:\n        /// - https://tools.ietf.org/html/draft-west-first-party-cookies-07#section-4.1\n        /// - https://tools.ietf.org/html/draft-west-cookie-incrementalism-00\n        /// - https://www.chromium.org/updates/same-site\n        /// - https://devblogs.microsoft.com/aspnet/upcoming-samesite-cookie-changes-in-asp-net-and-asp-net-core/\n        /// - https://bugs.webkit.org/show_bug.cgi?id=198181\n        /// </remarks>\n        /// <param name=\"services\">The service collection to register <see cref=\"CookiePolicyOptions\" /> into.</param>\n        /// <returns>The modified <see cref=\"IServiceCollection\" />.</returns>\n        public static IServiceCollection ConfigureNonBreakingSameSiteCookies(this IServiceCollection services)\n        {\n            services.Configure<CookiePolicyOptions>(options =>\n            {\n                options.MinimumSameSitePolicy = Unspecified;\n                options.OnAppendCookie = cookieContext =>\n                CheckSameSite(cookieContext.Context, cookieContext.CookieOptions);\n                options.OnDeleteCookie = cookieContext =>\n                CheckSameSite(cookieContext.Context, cookieContext.CookieOptions);\n            });\n\n            return services;\n        }\n\n        private static void CheckSameSite(HttpContext httpContext, CookieOptions options)\n        {\n            if (options.SameSite == SameSiteMode.None)\n            {\n                var userAgent = httpContext.Request.Headers[\"User-Agent\"].ToString();\n\n                if (DisallowsSameSiteNone(userAgent))\n                {\n                    options.SameSite = Unspecified;\n                }\n            }\n        }\n\n        /// <summary>\n        /// Checks if the UserAgent is known to interpret an unknown value as Strict.\n        /// For those the <see cref=\"CookieOptions.SameSite\" /> property should be\n        /// set to <see cref=\"Unspecified\" />.\n        /// </summary>\n        /// <remarks>\n        /// This code is taken from Microsoft:\n        /// https://devblogs.microsoft.com/aspnet/upcoming-samesite-cookie-changes-in-asp-net-and-asp-net-core/\n        /// </remarks>\n        /// <param name=\"userAgent\">The user agent string to check.</param>\n        /// <returns>Whether the specified user agent (browser) accepts SameSite=None or not.</returns>\n        private static bool DisallowsSameSiteNone(string userAgent)\n        {\n            // Cover all iOS based browsers here. This includes:\n            //   - Safari on iOS 12 for iPhone, iPod Touch, iPad\n            //   - WkWebview on iOS 12 for iPhone, iPod Touch, iPad\n            //   - Chrome on iOS 12 for iPhone, iPod Touch, iPad\n            // All of which are broken by SameSite=None, because they use the\n            // iOS networking stack.\n            // Notes from Thinktecture:\n            // Regarding https://caniuse.com/#search=samesite iOS versions lower\n            // than 12 are not supporting SameSite at all. Starting with version 13\n            // unknown values are NOT treated as strict anymore. Therefore we only\n            // need to check version 12.\n            if (userAgent.Contains(\"CPU iPhone OS 12\")\n               || userAgent.Contains(\"iPad; CPU OS 12\"))\n            {\n                return true;\n            }\n\n            // Cover Mac OS X based browsers that use the Mac OS networking stack.\n            // This includes:\n            //   - Safari on Mac OS X.\n            // This does not include:\n            //   - Chrome on Mac OS X\n            // because they do not use the Mac OS networking stack.\n            // Notes from Thinktecture:\n            // Regarding https://caniuse.com/#search=samesite MacOS X versions lower\n            // than 10.14 are not supporting SameSite at all. Starting with version\n            // 10.15 unknown values are NOT treated as strict anymore. Therefore we\n            // only need to check version 10.14.\n            if (userAgent.Contains(\"Safari\")\n               && userAgent.Contains(\"Macintosh; Intel Mac OS X 10_14\")\n               && userAgent.Contains(\"Version/\"))\n            {\n                return true;\n            }\n\n            // Cover Chrome 50-69, because some versions are broken by SameSite=None\n            // and none in this range require it.\n            // Note: this covers some pre-Chromium Edge versions,\n            // but pre-Chromium Edge does not require SameSite=None.\n            // Notes from Thinktecture:\n            // We can not validate this assumption, but we trust Microsofts\n            // evaluation. And overall not sending a SameSite value equals to the same\n            // behavior as SameSite=None for these old versions anyways.\n            if (userAgent.Contains(\"Chrome/5\") || userAgent.Contains(\"Chrome/6\"))\n            {\n                return true;\n            }\n\n            if (GetChromeVersion(userAgent) >= 80)\n            {\n                return true;\n            }\n\n            return false;\n        }\n\n        private static int GetChromeVersion(string userAgent)\n        {\n            try\n            {\n                return Convert.ToInt32(userAgent.Split(\"Chrome/\")[1].Split('.')[0]);\n            }\n            catch (Exception)\n            {\n                return 0;\n            }\n        }\n    }\n}\n"}]}]},{"type":"element","tag":"h3","props":{"id":"step-2"},"children":[{"type":"text","value":"Step-2"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Assume that your project name is "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Acme.BookStore"}]},{"type":"text","value":". Then open "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AcmeBookStoreWebModule.cs"}]},{"type":"text","value":" class."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Add the following line to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ConfigureServices()"}]},{"type":"text","value":" method."}]},{"type":"element","tag":"pre","props":{"className":["language-csharp"],"code":"context.Services.ConfigureNonBreakingSameSiteCookies();\n","language":"csharp","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"context.Services.ConfigureNonBreakingSameSiteCookies();\n"}]}]},{"type":"element","tag":"h3","props":{"id":"step-3"},"children":[{"type":"text","value":"Step-3"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Go to"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"OnApplicationInitialization()"}]},{"type":"text","value":" method in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AcmeBookStoreWebModule.cs"}]},{"type":"text","value":" add "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"app.UseCookiePolicy();"}]}]},{"type":"element","tag":"pre","props":{"className":["language-csharp"],"code":"public override void OnApplicationInitialization(ApplicationInitializationContext context)\n{\n        var app = context.GetApplicationBuilder();\n        var env = context.GetEnvironment();\n\n        if (env.IsDevelopment())\n        {\n                app.UseDeveloperExceptionPage();\n        }\n        else\n        {\n                app.UseErrorPage();\n                app.UseHsts();\n        }\n         // Before UseAuthentication or anything else that writes cookies.\n        app.UseCookiePolicy(); //<--- added this --->\n\n    //....\n}\n","language":"csharp","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"public override void OnApplicationInitialization(ApplicationInitializationContext context)\n{\n        var app = context.GetApplicationBuilder();\n        var env = context.GetEnvironment();\n\n        if (env.IsDevelopment())\n        {\n                app.UseDeveloperExceptionPage();\n        }\n        else\n        {\n                app.UseErrorPage();\n                app.UseHsts();\n        }\n         // Before UseAuthentication or anything else that writes cookies.\n        app.UseCookiePolicy(); //<--- added this --->\n\n    //....\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It's all! You are ready to go!"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Referenced from "},{"type":"element","tag":"a","props":{"href":"https://www.thinktecture.com/en/identity/samesite/prepare-your-identityserver/","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.thinktecture.com/en/identity/samesite/prepare-your-identityserver/"}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"introduction","depth":2,"text":"Introduction"},{"id":"how-to-solve-it","depth":2,"text":"How to solve it?","children":[{"id":"step-1","depth":3,"text":"Step-1"},{"id":"step-2","depth":3,"text":"Step-2"},{"id":"step-3","depth":3,"text":"Step-3"}]}]}},"_type":"markdown","_id":"content:dotnet:2020-12-11-chrome-login-fail.md","_source":"content","_file":"dotnet/2020-12-11-chrome-login-fail.md","_extension":"md","date":"2020-12-11"}