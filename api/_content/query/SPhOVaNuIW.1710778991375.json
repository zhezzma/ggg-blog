{"_path":"/dotnet/2020-06-11-identityserver-use","_dir":"dotnet","_draft":false,"_partial":false,"_locale":"","title":"2020 06 11 IdentityServer Use","description":"DotHass.Lobby.Domain\\IdentityServer\\IdentityServerDataSeedContributor.cs 中 CreateClientsAsync()","stitle":"IdentityServer使用指南","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"DotHass.Lobby.Domain\\IdentityServer\\IdentityServerDataSeedContributor.cs 中 CreateClientsAsync()"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"会在dataseed的时候生成默认数据"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When I try to send a HTTPS POST request from a desktop (Servers are in production environment) the following message is displayed inside the console :"}]},{"type":"element","tag":"pre","props":{"code":"Error: unable to verify the first certificate\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Error: unable to verify the first certificate\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"After: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Postman -> Preferences -> General -> SSL certificate validation -> OFF"}]},{"type":"text","value":" "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"it works"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://localhost:5000/.well-known/openid-configuration","rel":["nofollow"]},"children":[{"type":"text","value":"https://localhost:5000/.well-known/openid-configuration"}]}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://localhost:5000/connect/token","rel":["nofollow"]},"children":[{"type":"text","value":"http://localhost:5000/connect/token"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"image-20200613165200371","src":"/images/2020-06-11-IdentityServer-use/image-20200613165200371.png"},"children":[]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://localhost:5000/connect/userinfo","rel":["nofollow"]},"children":[{"type":"text","value":"http://localhost:5000/connect/userinfo"}]},{"type":"text","value":" 将type设置成bearer token,token填入上面获得的access_token"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image-20200613165246959","src":"/images/2020-06-11-IdentityServer-use/image-20200613165246959.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"3.注意发布release后.配置表中的  ..如果配置错误将会认证失败"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"appsettings.json"}]},{"type":"element","tag":"pre","props":{"code":"{\n  \"App\": {\n    \"SelfUrl\": \"http://localhost:5000\"\n  },\n  \"ConnectionStrings\": {\n    \"Default\": \"Server=localhost;User Id=root;Password=123456;Database=dothass.blog\"\n  },\n  \"AuthServer\": {\n    \"Authority\": \"http://localhost:5000\"\n  },\n  \"IdentityServer\": {\n    \"Clients\": {\n      \"Blog_App\": {\n        \"ClientId\": \"Blog_App\"\n      }\n    }\n  }\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"App\": {\n    \"SelfUrl\": \"http://localhost:5000\"\n  },\n  \"ConnectionStrings\": {\n    \"Default\": \"Server=localhost;User Id=root;Password=123456;Database=dothass.blog\"\n  },\n  \"AuthServer\": {\n    \"Authority\": \"http://localhost:5000\"\n  },\n  \"IdentityServer\": {\n    \"Clients\": {\n      \"Blog_App\": {\n        \"ClientId\": \"Blog_App\"\n      }\n    }\n  }\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"appsettings.Development.json"}]},{"type":"element","tag":"pre","props":{"code":"{\n  \"App\": {\n    \"SelfUrl\": \"https://localhost:44377\"\n  },\n  \"AuthServer\": {\n    \"Authority\": \"https://localhost:44377\"\n  }\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"App\": {\n    \"SelfUrl\": \"https://localhost:44377\"\n  },\n  \"AuthServer\": {\n    \"Authority\": \"https://localhost:44377\"\n  }\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"还要注意请求的域名是否一样,127.0.0.1或者localhost...可能返回结果即使一样.但是不能授权."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"使用"},{"type":"element","tag":"a","props":{"href":"http://jwt.calebb.net/%E8%A7%A3%E6%9E%90%E7%9C%8B%E4%B8%8Baccess_token","rel":["nofollow"]},"children":[{"type":"text","value":"http://jwt.calebb.net/解析看下access_token"}]}]},{"type":"element","tag":"pre","props":{"code":"{\n alg: \"RS256\",\n kid: \"1oauLjO2TtmvAH-4A7CCLg\",\n typ: \"at+jwt\"\n}.\n{\n nbf: 1592054993,\n exp: 1623590993,\n iss: \"http://127.0.0.1:5000\",\n aud: \"Blog\",\n client_id: \"Blog_App\",\n sub: \"fa9626f7-0f6f-6158-2afd-39f5a7f6d03f\",\n auth_time: 1592054993,\n idp: \"local\",\n role: \"admin\",\n name: \"admin\",\n email: \"admin@abp.io\",\n email_verified: false,\n scope: [\n  \"address\",\n  \"email\",\n  \"openid\",\n  \"phone\",\n  \"profile\",\n  \"role\",\n  \"Blog\",\n  \"offline_access\"\n ],\n amr: [\n  \"pwd\"\n ]\n}.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n alg: \"RS256\",\n kid: \"1oauLjO2TtmvAH-4A7CCLg\",\n typ: \"at+jwt\"\n}.\n{\n nbf: 1592054993,\n exp: 1623590993,\n iss: \"http://127.0.0.1:5000\",\n aud: \"Blog\",\n client_id: \"Blog_App\",\n sub: \"fa9626f7-0f6f-6158-2afd-39f5a7f6d03f\",\n auth_time: 1592054993,\n idp: \"local\",\n role: \"admin\",\n name: \"admin\",\n email: \"admin@abp.io\",\n email_verified: false,\n scope: [\n  \"address\",\n  \"email\",\n  \"openid\",\n  \"phone\",\n  \"profile\",\n  \"role\",\n  \"Blog\",\n  \"offline_access\"\n ],\n amr: [\n  \"pwd\"\n ]\n}.\n"}]}]},{"type":"element","tag":"pre","props":{"code":"    {\n alg: \"RS256\",\n kid: \"1oauLjO2TtmvAH-4A7CCLg\",\n typ: \"at+jwt\"\n}.\n{\n nbf: 1592055396,\n exp: 1623591396,\n iss: \"http://localhost:5000\",\n aud: \"Blog\",\n client_id: \"Blog_App\",\n sub: \"fa9626f7-0f6f-6158-2afd-39f5a7f6d03f\",\n auth_time: 1592055396,\n idp: \"local\",\n role: \"admin\",\n name: \"admin\",\n email: \"admin@abp.io\",\n email_verified: false,\n scope: [\n  \"address\",\n  \"email\",\n  \"openid\",\n  \"phone\",\n  \"profile\",\n  \"role\",\n  \"Blog\",\n  \"offline_access\"\n ],\n amr: [\n  \"pwd\"\n ]\n}.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    {\n alg: \"RS256\",\n kid: \"1oauLjO2TtmvAH-4A7CCLg\",\n typ: \"at+jwt\"\n}.\n{\n nbf: 1592055396,\n exp: 1623591396,\n iss: \"http://localhost:5000\",\n aud: \"Blog\",\n client_id: \"Blog_App\",\n sub: \"fa9626f7-0f6f-6158-2afd-39f5a7f6d03f\",\n auth_time: 1592055396,\n idp: \"local\",\n role: \"admin\",\n name: \"admin\",\n email: \"admin@abp.io\",\n email_verified: false,\n scope: [\n  \"address\",\n  \"email\",\n  \"openid\",\n  \"phone\",\n  \"profile\",\n  \"role\",\n  \"Blog\",\n  \"offline_access\"\n ],\n amr: [\n  \"pwd\"\n ]\n}.\n"}]}]},{"type":"element","tag":"h1","props":{"id":"错误"},"children":[{"type":"text","value":"错误"}]},{"type":"element","tag":"pre","props":{"code":"System.InvalidOperationException: IDX20803: Unable to obtain configuration from: '[PII is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.\n ---> System.IO.IOException: IDX20804: Unable to retrieve document from: '[PII is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.\n ---> System.Net.Http.HttpRequestException: The SSL connection could not be established, see inner exception.\n ---> System.Security.Authentication.AuthenticationException: The remote certificate is invalid according to the validation procedure.\n   at System.Net.Security.SslStream.StartSendAuthResetSignal(ProtocolToken message, AsyncProtocolRequest asyncRequest, ExceptionDispatchInfo exception)\n   at System.Net.Security.SslStream.CheckCompletionBeforeNextReceive(ProtocolToken message, AsyncProtocolRequest asyncRequest)\n   at System.Net.Security.SslStream.StartSendBlob(Byte[] incoming, Int32 count, AsyncProtocolRequest asyncRequest)\n   at System.Net.Security.SslStream.ProcessReceivedBlob(Byte[] buffer, Int32 count, AsyncProtocolRequest asyncRequest)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"System.InvalidOperationException: IDX20803: Unable to obtain configuration from: '[PII is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.\n ---> System.IO.IOException: IDX20804: Unable to retrieve document from: '[PII is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.\n ---> System.Net.Http.HttpRequestException: The SSL connection could not be established, see inner exception.\n ---> System.Security.Authentication.AuthenticationException: The remote certificate is invalid according to the validation procedure.\n   at System.Net.Security.SslStream.StartSendAuthResetSignal(ProtocolToken message, AsyncProtocolRequest asyncRequest, ExceptionDispatchInfo exception)\n   at System.Net.Security.SslStream.CheckCompletionBeforeNextReceive(ProtocolToken message, AsyncProtocolRequest asyncRequest)\n   at System.Net.Security.SslStream.StartSendBlob(Byte[] incoming, Int32 count, AsyncProtocolRequest asyncRequest)\n   at System.Net.Security.SslStream.ProcessReceivedBlob(Byte[] buffer, Int32 count, AsyncProtocolRequest asyncRequest)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"可以看出来这些问题是和SSL证书有关，经过排查，发现IdentityServer4配置中：使用了"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"IP"}]},{"type":"text","value":"的形式配置的授权地址，但是SSL证书是以域名形式申请的，这就造成了SSL证书不能验证通过。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"解决方法："},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"将授权地址配置为域名:端口的形式"}]},{"type":"text","value":"，完美解决上述问题。注意域名为SSL证书申请时用到的域名。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"localhost使用的是开发证书,也是类似域名,127.0.0.1也是有问题的"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:dotnet:2020-06-11-IdentityServer-use.md","_source":"content","_file":"dotnet/2020-06-11-IdentityServer-use.md","_extension":"md","date":"2020-06-11"}