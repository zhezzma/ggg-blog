{"_path":"/dotnet/2020-07-15-abp-default-language","_dir":"dotnet","_draft":false,"_partial":false,"_locale":"","title":"abp默认语言规则","description":"abp是依托与aspnetcore的.我们先来看看aspnetcore是怎么实现的","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"abp默认语言规则"},"children":[{"type":"text","value":"abp默认语言规则"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"abp是依托与aspnetcore的.我们先来看看aspnetcore是怎么实现的"}]},{"type":"element","tag":"pre","props":{"code":"\n    services.Configure<RequestLocalizationOptions>(options =>\n        {\n            var supportedCultures = new List<CultureInfo>\n            {\n                new CultureInfo(\"en-US\"),\n                new CultureInfo(\"en\"),\n                new CultureInfo(\"fr-FR\"),\n                new CultureInfo(\"fr\")\n            };\n\n            options.DefaultRequestCulture = new RequestCulture(\"en-US\");\n            options.SupportedCultures = supportedCultures;\n            options.SupportedUICultures = supportedCultures;\n        });\n        \n        \n        //中间件\n        app.UseRequestLocalization();\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"\n    services.Configure<RequestLocalizationOptions>(options =>\n        {\n            var supportedCultures = new List<CultureInfo>\n            {\n                new CultureInfo(\"en-US\"),\n                new CultureInfo(\"en\"),\n                new CultureInfo(\"fr-FR\"),\n                new CultureInfo(\"fr\")\n            };\n\n            options.DefaultRequestCulture = new RequestCulture(\"en-US\");\n            options.SupportedCultures = supportedCultures;\n            options.SupportedUICultures = supportedCultures;\n        });\n        \n        \n        //中间件\n        app.UseRequestLocalization();\n"}]}]},{"type":"element","tag":"h2","props":{"id":"中间件request的语言判断"},"children":[{"type":"text","value":"中间件request的语言判断"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在每次请求里 "},{"type":"element","tag":"a","props":{"href":"https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNet/Localization/RequestLocalizationOptions/index.html","rel":["nofollow"]},"children":[{"type":"text","value":"RequestLocalizationOptions"}]},{"type":"text","value":" 的 "},{"type":"element","tag":"a","props":{"href":"https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Localization/RequestCultureProvider/index.html","rel":["nofollow"]},"children":[{"type":"text","value":"RequestCultureProvider"}]},{"type":"text","value":" 列表会被遍历，第一个provider 会被使用来判断请求使用的文化。默认的 provider 来自"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"RequestLocalizationOptions"}]},{"type":"text","value":" 类,如果没有非空的 provider，"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DefaultRequestCulture"}]},{"type":"text","value":" 被使用。所以如果发现语言不是按照逻辑顺序显示,先检查请求网址,再检查"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"cookie"}]},{"type":"text","value":"(很难注意到),最后检查acceptlanguage"}]},{"type":"element","tag":"h3","props":{"id":"querystringrequestcultureprovider"},"children":[{"type":"element","tag":"a","props":{"href":"https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Localization/QueryStringRequestCultureProvider/index.html","rel":["nofollow"]},"children":[{"type":"text","value":"QueryStringRequestCultureProvider"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"下面的例子指定了具体的区域性（语言和区域）设置为西班牙语/墨西哥："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://localhost:5000/?culture=es-MX&ui-culture=es-MX","rel":["nofollow"]},"children":[{"type":"text","value":"http://localhost:5000/?culture=es-MX&ui-culture=es-MX"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果你仅仅使用（culture 或者 ui-culture）中的一个参数进行传递，查询字符串 provider 将使用你传递一个值来设置这两个参数。例如，仅设置culture，将会同样设置 Culture 和 UICulture："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://localhost:5000/?culture=es-MX","rel":["nofollow"]},"children":[{"type":"text","value":"http://localhost:5000/?culture=es-MX"}]}]},{"type":"element","tag":"h3","props":{"id":"cookierequestcultureprovider"},"children":[{"type":"element","tag":"a","props":{"href":"https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Localization/CookieRequestCultureProvider/index.html","rel":["nofollow"]},"children":[{"type":"text","value":"CookieRequestCultureProvider"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CookieRequestCultureProvider 的 DefaultCookieName 返回用于跟踪用户的首选区域性信息默认的 Cookie 名称。默认的 Cookie 名称是 “.AspNetCore.Culture”。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"cookie 的格式是 c=%LANGCODE%|uic=%LANGCODE%, c 为区域信息 和 uic 为 UI 区域信息，例如："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"c=’en-UK’|uic=’en-US’"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果仅指定 culture 或 UI culture中的一个，指定的区域性信息将同时用于 culture和 UI culture。"}]},{"type":"element","tag":"h3","props":{"id":"acceptlanguageheaderrequestcultureprovider"},"children":[{"type":"element","tag":"a","props":{"href":"https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Localization/AcceptLanguageHeaderRequestCultureProvider/index.html","rel":["nofollow"]},"children":[{"type":"text","value":"AcceptLanguageHeaderRequestCultureProvider"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这个一般是根据浏览器的设置进行访问的\n"},{"type":"element","tag":"img","props":{"alt":"image-20200719113919074","src":"/images/2020-07-15-abp-default-language/image-20200719113919074.png"},"children":[]},{"type":"text","value":"\n不同的浏览器默认语言不同,chrome浏览器可以再语言里设置"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"img","src":"/images/2020-07-15-abp-default-language/c83d70cf3bc79f3d3ec73c6db4a1cd11728b294d.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"cultures"},"children":[{"type":"text","value":"Cultures"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SupportedCultures"}]},{"type":"text","value":" 的 "},{"type":"element","tag":"a","props":{"href":"https://msdn.microsoft.com/en-us/library/system.globalization.cultureinfo(v=vs.110).aspx","rel":["nofollow"]},"children":[{"type":"text","value":"CultureInfo"}]},{"type":"text","value":" 对象决定了和文化相关的函数，如日期，时间，数字和货币格式的结果。同时决定了文字如何排序，大小写转换以及字符串比较。参考"},{"type":"element","tag":"a","props":{"href":"https://msdn.microsoft.com/en-us/library/system.globalization.cultureinfo.currentculture(v=vs.110).aspx","rel":["nofollow"]},"children":[{"type":"text","value":"CultureInfo.CurrentCulture"}]},{"type":"text","value":" 获取更多关于服务器如何获取文化的信息。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"SupportedUICultures"}]},{"type":"text","value":" 决定如何通过 "},{"type":"element","tag":"a","props":{"href":"https://msdn.microsoft.com/en-us/library/system.resources.resourcemanager(v=vs.110).aspx","rel":["nofollow"]},"children":[{"type":"text","value":"ResourceManager"}]},{"type":"text","value":" 查找翻译字符串（从 "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":".resx"}]},{"type":"text","value":" 文件）。 "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"ResourceManager"}]},{"type":"text","value":" 只是通过 CurrentUICulture 简单的查找指定文化的字符串。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":".NET 的每个线程都会拥有 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CurrentCulture"}]},{"type":"text","value":" 和"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"CurrentUICulture"}]},{"type":"text","value":" 对象。当 ASP.NET Core 在渲染与文化相关的函数的时候会检视这些对象值。例如，如果当前线程的区域性设置为 “en-US” （英语、美国）， "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"DateTime.Now.ToLongDateString() \"Thursday, February 18, 2016\""}]},{"type":"text","value":" ，但如果 CurrentCulture 设置为 “es-ES”（西班牙语、西班牙），输出将会是 “jueves, 18 de febrero de 2016”。"}]},{"type":"element","tag":"h2","props":{"id":"abp的实现"},"children":[{"type":"text","value":"abp的实现"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Volo.Abp.AspNetCore项目中DefaultAbpRequestLocalizationOptionsProvider.cs"}]},{"type":"element","tag":"pre","props":{"code":"#GetLocalizationOptionsAsync()\n#根据设置获取默认语言,如果默认语言为en\nvar languages = await languageProvider.GetLanguagesAsync();\nvar defaultLanguage = await settingProvider.GetOrNullAsync(LocalizationSettingNames.DefaultLanguage);\n\nvar options = !languages.Any()\n? new RequestLocalizationOptions()\n: new RequestLocalizationOptions\n{\nDefaultRequestCulture = DefaultGetRequestCulture(defaultLanguage, languages),\n\nSupportedCultures = languages\n.Select(l => l.CultureName)\n.Distinct()\n.Select(c => new CultureInfo(c))\n.ToArray(),\n\nSupportedUICultures = languages\n.Select(l => l.UiCultureName)\n.Distinct()\n.Select(c => new CultureInfo(c))\n.ToArray()\n};\n\n#如果设置中的默认语言不存在,则选取第一个语言作为默认语言\nprivate static RequestCulture DefaultGetRequestCulture(string defaultLanguage, IReadOnlyList<LanguageInfo> languages)\n{\n    if (defaultLanguage == null)\n    {\n    var firstLanguage = languages.First();\n    return new RequestCulture(firstLanguage.CultureName, firstLanguage.UiCultureName);\n    }\n\n    var (cultureName, uiCultureName) = LocalizationSettingHelper.ParseLanguageSetting(defaultLanguage);\n    return new RequestCulture(cultureName, uiCultureName);\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"#GetLocalizationOptionsAsync()\n#根据设置获取默认语言,如果默认语言为en\nvar languages = await languageProvider.GetLanguagesAsync();\nvar defaultLanguage = await settingProvider.GetOrNullAsync(LocalizationSettingNames.DefaultLanguage);\n\nvar options = !languages.Any()\n? new RequestLocalizationOptions()\n: new RequestLocalizationOptions\n{\nDefaultRequestCulture = DefaultGetRequestCulture(defaultLanguage, languages),\n\nSupportedCultures = languages\n.Select(l => l.CultureName)\n.Distinct()\n.Select(c => new CultureInfo(c))\n.ToArray(),\n\nSupportedUICultures = languages\n.Select(l => l.UiCultureName)\n.Distinct()\n.Select(c => new CultureInfo(c))\n.ToArray()\n};\n\n#如果设置中的默认语言不存在,则选取第一个语言作为默认语言\nprivate static RequestCulture DefaultGetRequestCulture(string defaultLanguage, IReadOnlyList<LanguageInfo> languages)\n{\n    if (defaultLanguage == null)\n    {\n    var firstLanguage = languages.First();\n    return new RequestCulture(firstLanguage.CultureName, firstLanguage.UiCultureName);\n    }\n\n    var (cultureName, uiCultureName) = LocalizationSettingHelper.ParseLanguageSetting(defaultLanguage);\n    return new RequestCulture(cultureName, uiCultureName);\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"然后中间件是"}]},{"type":"element","tag":"pre","props":{"code":"app.UseAbpRequestLocalization();\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"app.UseAbpRequestLocalization();\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"中间件使用的是AbpRequestLocalizationMiddleware,其实它只是对aspnetcore的RequestLocalizationMiddleware进行了一层包装"}]},{"type":"element","tag":"h3","props":{"id":"如何修改默认语言"},"children":[{"type":"text","value":"如何修改默认语言"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先注意浏览器发送的中文的"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"accept-language"}]},{"type":"text","value":"的值与ABP值是不一样的:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"浏览器(如Chrome)的值为"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"zh-CN"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"而ABP的简体中文的值为"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"zh-Hans"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先修改配置文件appsettings.json"}]},{"type":"element","tag":"pre","props":{"code":"\"Settings\": {\n    \"Abp.Localization.DefaultLanguage\": \"zh-Hans\"\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"\"Settings\": {\n    \"Abp.Localization.DefaultLanguage\": \"zh-Hans\"\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"然后在中间件中删除AcceptLanguageHeaderRequestCultureProvider"}]},{"type":"element","tag":"pre","props":{"code":"app.UseAbpRequestLocalization(options =>\n    {\n        options.RequestCultureProviders.RemoveAll(provider => provider is AcceptLanguageHeaderRequestCultureProvider);\n    }\n);\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"app.UseAbpRequestLocalization(options =>\n    {\n        options.RequestCultureProviders.RemoveAll(provider => provider is AcceptLanguageHeaderRequestCultureProvider);\n    }\n);\n"}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"中间件request的语言判断","depth":2,"text":"中间件request的语言判断","children":[{"id":"querystringrequestcultureprovider","depth":3,"text":"QueryStringRequestCultureProvider"},{"id":"cookierequestcultureprovider","depth":3,"text":"CookieRequestCultureProvider"},{"id":"acceptlanguageheaderrequestcultureprovider","depth":3,"text":"AcceptLanguageHeaderRequestCultureProvider"}]},{"id":"cultures","depth":2,"text":"Cultures"},{"id":"abp的实现","depth":2,"text":"abp的实现","children":[{"id":"如何修改默认语言","depth":3,"text":"如何修改默认语言"}]}]}},"_type":"markdown","_id":"content:dotnet:2020-07-15-abp-default-language.md","_source":"content","_file":"dotnet/2020-07-15-abp-default-language.md","_extension":"md","date":"2020-07-15"}