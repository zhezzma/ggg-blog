{"_path":"/tool/2021-11-07-cockpit-linux","_dir":"tool","_draft":false,"_partial":false,"_locale":"","title":"安装cockpit通过nginx代理访问","description":"安装cockpit后，默认只能通过IP地址+端口号来访问。其实，还可以通过nginx代理来访问。","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"安装cockpit后，默认只能通过IP地址+端口号来访问。其实，还可以通过nginx代理来访问。"}]},{"type":"element","tag":"h2","props":{"id":"添加nginxconf配置"},"children":[{"type":"text","value":"添加Nginx.conf配置"}]},{"type":"element","tag":"pre","props":{"code":" \n## 添加并修改\nvi /etc/nginx/conf.d/cockpit.godgodgame.com\n\n-------------------------------------------------------------------------------------\n\n#使用cockpt名称配置上游服务器\nupstream cockpit {\n    server 127.0.0.1:9090;\n}\n \n#将http重定向到https\nserver{\n    listen 80;\n    server_name cockpit.godgodgame.com;\n    return 301 https://$server_name$request_uri;\n}\n\n#使用https访问并配置ssl\nserver {\n    listen 443 ssl http2;\n    #填写绑定证书的域名\n    server_name cockpit.godgodgame.com;\n    \n    \n    #证书文件名称\n    ssl_certificate /etc/nginx/cert/1_godgodgame.com_bundle.crt;\n    #私钥文件名称\n    ssl_certificate_key /etc/nginx/cert/2_godgodgame.com.key;\n    ssl_session_timeout 5m;\n    #请按照以下协议配置\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2; \n    #请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; \n    ssl_prefer_server_ciphers on;\n \n    location / {\n        # Required to proxy the connection to Cockpit\n        proxy_pass https://cockpit;\n        proxy_set_header Host $host;\n        proxy_set_header X-Forwarded-Proto $scheme;\n\n        # Required for web sockets to function\n        proxy_http_version 1.1;\n        proxy_buffering off;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n\n        # Pass ETag header from Cockpit to clients.\n        # See: https://github.com/cockpit-project/cockpit/issues/5239\n        gzip off;\n    }\n}\n-------------------------------------------------------------------------------------\n# 先检查nginx配置是否有效/无有异常,如果有异常请按照异常提示修改；使用nginx -t进行nginx.conf的配置检测\n$ nginx -t;\n \n# 重启nginx\n$ nginx -s reload;\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":" \n## 添加并修改\nvi /etc/nginx/conf.d/cockpit.godgodgame.com\n\n-------------------------------------------------------------------------------------\n\n#使用cockpt名称配置上游服务器\nupstream cockpit {\n    server 127.0.0.1:9090;\n}\n \n#将http重定向到https\nserver{\n    listen 80;\n    server_name cockpit.godgodgame.com;\n    return 301 https://$server_name$request_uri;\n}\n\n#使用https访问并配置ssl\nserver {\n    listen 443 ssl http2;\n    #填写绑定证书的域名\n    server_name cockpit.godgodgame.com;\n    \n    \n    #证书文件名称\n    ssl_certificate /etc/nginx/cert/1_godgodgame.com_bundle.crt;\n    #私钥文件名称\n    ssl_certificate_key /etc/nginx/cert/2_godgodgame.com.key;\n    ssl_session_timeout 5m;\n    #请按照以下协议配置\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2; \n    #请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; \n    ssl_prefer_server_ciphers on;\n \n    location / {\n        # Required to proxy the connection to Cockpit\n        proxy_pass https://cockpit;\n        proxy_set_header Host $host;\n        proxy_set_header X-Forwarded-Proto $scheme;\n\n        # Required for web sockets to function\n        proxy_http_version 1.1;\n        proxy_buffering off;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n\n        # Pass ETag header from Cockpit to clients.\n        # See: https://github.com/cockpit-project/cockpit/issues/5239\n        gzip off;\n    }\n}\n-------------------------------------------------------------------------------------\n# 先检查nginx配置是否有效/无有异常,如果有异常请按照异常提示修改；使用nginx -t进行nginx.conf的配置检测\n$ nginx -t;\n \n# 重启nginx\n$ nginx -s reload;\n"}]}]},{"type":"element","tag":"h2","props":{"id":"修改cockpit"},"children":[{"type":"text","value":"修改Cockpit"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这时输入域名，能看到登录页面，但登录后，显示不出内容，页面全白"}]},{"type":"element","tag":"pre","props":{"code":"sudo vim /etc/cockpit/cockpit.conf\n\n参照如下配置修改，注意域名替换为your_domain_host：\n[WebService]\nOrigins = https://cockpit.godgodgame.com https://127.0.0.1:9090\nProtocolHeader = X-Forwarded-Proto\nAllowUnencrypted = true\n\nsystemctl restart cockpit\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"sudo vim /etc/cockpit/cockpit.conf\n\n参照如下配置修改，注意域名替换为your_domain_host：\n[WebService]\nOrigins = https://cockpit.godgodgame.com https://127.0.0.1:9090\nProtocolHeader = X-Forwarded-Proto\nAllowUnencrypted = true\n\nsystemctl restart cockpit\n"}]}]},{"type":"element","tag":"pre","props":{"code":"map $http_upgrade $connection_upgrade { default upgrade; '' close; }\n \nupstream websocket {\nserver 127.0.0.1:9090;\n}\n \nserver{\n    listen 80;\n    server_name cockpit.godgodgame.com;\n    return 301 https://$server_name$request_uri;\n}\n \nserver {\n    listen 443 ssl http2;\n    server_name cockpit.godgodgame.com;\n \n    #ssl on;\n    ssl_certificate /etc/nginx/cert/1_cockpit.godgodgame.com_bundle.crt;\n    ssl_certificate_key /etc/nginx/cert/2_cockpit.godgodgame.com.key;\n \n    location / {\n        root /;\n        index index.html;\n        proxy_redirect off;\n        proxy_pass http://websocket;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n        proxy_set_header Host $http_host;\n    }\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"map $http_upgrade $connection_upgrade { default upgrade; '' close; }\n \nupstream websocket {\nserver 127.0.0.1:9090;\n}\n \nserver{\n    listen 80;\n    server_name cockpit.godgodgame.com;\n    return 301 https://$server_name$request_uri;\n}\n \nserver {\n    listen 443 ssl http2;\n    server_name cockpit.godgodgame.com;\n \n    #ssl on;\n    ssl_certificate /etc/nginx/cert/1_cockpit.godgodgame.com_bundle.crt;\n    ssl_certificate_key /etc/nginx/cert/2_cockpit.godgodgame.com.key;\n \n    location / {\n        root /;\n        index index.html;\n        proxy_redirect off;\n        proxy_pass http://websocket;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n        proxy_set_header Host $http_host;\n    }\n}\n"}]}]},{"type":"element","tag":"h2","props":{"id":"参考链接"},"children":[{"type":"text","value":"参考链接"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/cockpit-project/cockpit/wiki/Proxying-Cockpit-over-nginx","rel":["nofollow"]},"children":[{"type":"text","value":"Proxying Cockpit over nginx · cockpit-project/cockpit Wiki (github.com)"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://cloud.tencent.com/document/product/400/35244","rel":["nofollow"]},"children":[{"type":"text","value":"https://cloud.tencent.com/document/product/400/35244"}]}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"添加nginxconf配置","depth":2,"text":"添加Nginx.conf配置"},{"id":"修改cockpit","depth":2,"text":"修改Cockpit"},{"id":"参考链接","depth":2,"text":"参考链接"}]}},"_type":"markdown","_id":"content:tool:2021-11-07-cockpit-linux.md","_source":"content","_file":"tool/2021-11-07-cockpit-linux.md","_extension":"md","date":"2021-11-07"}