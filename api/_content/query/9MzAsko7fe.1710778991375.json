{"_path":"/tool/2020-01-12-centosn-ss-install","_dir":"tool","_draft":false,"_partial":false,"_locale":"","title":"CentOS 下安装Shadowsocks 搭建ss","description":"CentOS 7 开始默认使用Systemd作为开启启动脚本的管理工具，Shadowsocks则是当前比较受欢迎的科学上网工具，本文将介绍如何在 CentOS 下安装和配置 Shadowsocks 服务。","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"CentOS 7 开始默认使用"},{"type":"element","tag":"a","props":{"href":"https://en.wikipedia.org/wiki/Systemd","rel":["nofollow"]},"children":[{"type":"text","value":"Systemd"}]},{"type":"text","value":"作为开启启动脚本的管理工具，"},{"type":"element","tag":"a","props":{"href":"https://github.com/shadowsocks/","rel":["nofollow"]},"children":[{"type":"text","value":"Shadowsocks"}]},{"type":"text","value":"则是当前比较受欢迎的科学上网工具，本文将介绍如何在 CentOS 下安装和配置 Shadowsocks 服务。"}]},{"type":"element","tag":"h2","props":{"id":"安装-pip"},"children":[{"type":"text","value":"安装 pip"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://pip.pypa.io/en/stable/installing/","rel":["nofollow"]},"children":[{"type":"text","value":"pip"}]},{"type":"text","value":"是 python 的包管理工具。在本文中将使用 python 版本的 shadowsocks，此版本的 shadowsocks 已发布到 pip 上，因此我们需要通过 pip 命令来安装。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在控制台执行以下命令安装 pip："}]},{"type":"element","tag":"pre","props":{"code":"curl \"https://bootstrap.pypa.io/get-pip.py\" -o \"get-pip.py\"\npython3 get-pip.py\n","language":"bash","meta":"","className":["language-bash"]},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"curl \"https://bootstrap.pypa.io/get-pip.py\" -o \"get-pip.py\"\npython3 get-pip.py\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"或者"}]},{"type":"element","tag":"pre","props":{"code":"sudo yum -y install epel-release\nsudo yum -y install python-pip\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"sudo yum -y install epel-release\nsudo yum -y install python-pip\n"}]}]},{"type":"element","tag":"h2","props":{"id":"安装配置-shadowsocks"},"children":[{"type":"text","value":"安装配置 shadowsocks"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在控制台执行以下命令安装 shadowsocks："}]},{"type":"element","tag":"pre","props":{"code":"pip install --upgrade pip\npip install shadowsocks\n","language":"bash","meta":"","className":["language-bash"]},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"pip install --upgrade pip\npip install shadowsocks\n"}]}]},{"type":"element","tag":"h2","props":{"id":"客户端"},"children":[{"type":"text","value":"客户端"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"需要创建配置文件"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/etc/shadowsocks.json"}]},{"type":"text","value":"，内容如下："}]},{"type":"element","tag":"pre","props":{"code":"{\n    \"server\":\"1.1.1.1\",\n    \"server_port\":1035,\n    \"local_address\": \"127.0.0.1\",\n    \"local_port\":1080,\n    \"password\":\"password\",\n    \"timeout\":300,\n    \"method\":\"aes-256-cfb\",\n    \"fast_open\": false,\n    \"workers\": 1\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n    \"server\":\"1.1.1.1\",\n    \"server_port\":1035,\n    \"local_address\": \"127.0.0.1\",\n    \"local_port\":1080,\n    \"password\":\"password\",\n    \"timeout\":300,\n    \"method\":\"aes-256-cfb\",\n    \"fast_open\": false,\n    \"workers\": 1\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"配置说明："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"server：Shadowsocks服务器地址"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"server_port：Shadowsocks服务器端口"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"local_address：本地IP，本地使用的 sock5 代理 ip"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"local_port：本地端口，本地使用的 sock5 代理端口"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"password：Shadowsocks连接密码"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"timeout：等待超时时间"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"method：加密方式"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"workers:工作线程数"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"fast_open：true或false。开启fast_open以降低延迟，但要求Linux内核在3.7+。开启方法 echo 3 > /proc/sys/net/ipv4/tcp_fastopen"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"上述配置需要根据情况进行修改，接下来需要启动服务，就可以通过 local_address 和 local_port 来使用 sock5 代理，流量就可以走 ss 了"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"配置启动脚本文件 /etc/systemd/system/shadowsocks.service"}]},{"type":"element","tag":"pre","props":{"code":"[Unit]\nDescription=Shadowsocks\n\n[Service]\nTimeoutStartSec=0\nExecStart=/usr/bin/sslocal -c /etc/shadowsocks/shadowsocks.json\n\n[Install]\nWantedBy=multi-user.target\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[Unit]\nDescription=Shadowsocks\n\n[Service]\nTimeoutStartSec=0\nExecStart=/usr/bin/sslocal -c /etc/shadowsocks/shadowsocks.json\n\n[Install]\nWantedBy=multi-user.target\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"启用启动脚本，启动 ss 服务"}]},{"type":"element","tag":"pre","props":{"code":"# 配置服务开机启动\nsudo systemctl enable shadowsocks.service\n# 启动服务\nsudo systemctl start shadowsocks.service\n# 查看服务状态\nsudo systemctl status shadowsocks.service\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# 配置服务开机启动\nsudo systemctl enable shadowsocks.service\n# 启动服务\nsudo systemctl start shadowsocks.service\n# 查看服务状态\nsudo systemctl status shadowsocks.service\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"验证安装"}]},{"type":"element","tag":"pre","props":{"code":"$ curl --socks5 127.0.0.1:1080 http://httpbin.org/ip\n{\"origin\":\"x.x.x.x\"}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ curl --socks5 127.0.0.1:1080 http://httpbin.org/ip\n{\"origin\":\"x.x.x.x\"}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"至此就完成了 ss 客户端的安装配置。"}]},{"type":"element","tag":"h3","props":{"id":"前台运行"},"children":[{"type":"text","value":"前台运行"}]},{"type":"element","tag":"pre","props":{"code":"sslocal -c /etc/shadowsocks.json\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"sslocal -c /etc/shadowsocks.json\n"}]}]},{"type":"element","tag":"h3","props":{"id":"后台运行"},"children":[{"type":"text","value":"后台运行"}]},{"type":"element","tag":"pre","props":{"code":"sslocal -c /etc/shadowsocks.json -d start\nsslocal -c /etc/shadowsocks.json -d stop\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"sslocal -c /etc/shadowsocks.json -d start\nsslocal -c /etc/shadowsocks.json -d stop\n"}]}]},{"type":"element","tag":"h2","props":{"id":"method-aes-256-gcm-not-supported方法"},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"method aes-256-gcm not supported"}]},{"type":"text","value":"方法"}]},{"type":"element","tag":"pre","props":{"code":"pip install https://github.com/shadowsocks/shadowsocks/archive/master.zip -U\napt-get install build-essential\nwget https://download.libsodium.org/libsodium/releases/LATEST.tar.gz\ntar xf LATEST.tar.gz && cd libsodium-*.*.*\n./configure && make -j4 && make install\nldconfig\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"pip install https://github.com/shadowsocks/shadowsocks/archive/master.zip -U\napt-get install build-essential\nwget https://download.libsodium.org/libsodium/releases/LATEST.tar.gz\ntar xf LATEST.tar.gz && cd libsodium-*.*.*\n./configure && make -j4 && make install\nldconfig\n"}]}]},{"type":"element","tag":"h1","props":{"id":"proxychains"},"children":[{"type":"text","value":"proxychains"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"proxychains 的官方介绍："}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"proxychains ng (new generation) - a preloader which hooks calls to sockets in dynamically linked programs and redirects it through one or more socks/http proxies."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"proxychains 是一种访问代理的方式，用法如下："}]},{"type":"element","tag":"pre","props":{"code":"proxychains4 curl http://httpbin.org/ip\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"proxychains4 curl http://httpbin.org/ip\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这样可以使得 curl 走代理来访问网络。"}]},{"type":"element","tag":"h2","props":{"id":"安装"},"children":[{"type":"text","value":"安装"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先去 "},{"type":"element","tag":"a","props":{"href":"https://github.com/rofl0r/proxychains-ng","rel":["nofollow"]},"children":[{"type":"text","value":"proxychains 官网"}]},{"type":"text","value":" 下载代码进行编译安装，常规的 configure && make 方式，没啥特别之处。"}]},{"type":"element","tag":"pre","props":{"code":"./configure\n\nmake -j\n\nsudo make install\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"./configure\n\nmake -j\n\nsudo make install\n"}]}]},{"type":"element","tag":"h2","props":{"id":"配置"},"children":[{"type":"text","value":"配置"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"创建配置文件"}]},{"type":"element","tag":"pre","props":{"code":"mkdir -p ~/.proxychains\nvi ~/.proxychains/proxychains.conf\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"mkdir -p ~/.proxychains\nvi ~/.proxychains/proxychains.conf\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"proxychains.conf 配置如下："}]},{"type":"element","tag":"pre","props":{"code":"strict_chain\nproxy_dns\nremote_dns_subnet 224\ntcp_read_time_out 15000\ntcp_connect_time_out 8000\nlocalnet 127.0.0.0/255.0.0.0\nquiet_mode\n\n[ProxyList]\nsocks5  127.0.0.1 1080\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"strict_chain\nproxy_dns\nremote_dns_subnet 224\ntcp_read_time_out 15000\ntcp_connect_time_out 8000\nlocalnet 127.0.0.0/255.0.0.0\nquiet_mode\n\n[ProxyList]\nsocks5  127.0.0.1 1080\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ProxyList 的配置要与上面的 ss 配置一致，即可通过代理访问网络，使用起来还是很方便的。"}]},{"type":"element","tag":"h2","props":{"id":"用法"},"children":[{"type":"text","value":"用法"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"proxychains 可以通过启动一个 bash 来使得当前终端全局走代理"}]},{"type":"element","tag":"pre","props":{"code":"proxychains4 bash\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"proxychains4 bash\n"}]}]},{"type":"element","tag":"h2","props":{"id":"服务端"},"children":[{"type":"text","value":"服务端"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"需要创建配置文件"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/etc/shadowsocks.json"}]},{"type":"text","value":"，内容如下："}]},{"type":"element","tag":"pre","props":{"code":"{\n  \"server\": \"0.0.0.0\",\n  \"server_port\": 8388,\n  \"password\": \"uzon57jd0v869t7w\",\n  \"method\": \"aes-256-cfb\"\n}\n","language":"json","meta":"","className":["language-json"]},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"server\": \"0.0.0.0\",\n  \"server_port\": 8388,\n  \"password\": \"uzon57jd0v869t7w\",\n  \"method\": \"aes-256-cfb\"\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"说明："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"method"}]},{"type":"text","value":"为加密方法，可选"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"aes-128-cfb, aes-192-cfb, aes-256-cfb, bf-cfb, cast5-cfb, des-cfb, rc4-md5, chacha20, salsa20, rc4, table"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"server_port"}]},{"type":"text","value":"为服务监听端口"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"password"}]},{"type":"text","value":"为密码，可使用"},{"type":"element","tag":"a","props":{"href":"http://ucdok.com/project/generate_password.html","rel":["nofollow"]},"children":[{"type":"text","value":"密码生成工具"}]},{"type":"text","value":"生成一个随机密码"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"以上三项信息在配置 shadowsocks 客户端时需要配置一致，具体说明可查看 shadowsocks 的帮助文档。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"新建启动脚本文件"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/etc/systemd/system/shadowsocks.service"}]},{"type":"text","value":"，内容如下："}]},{"type":"element","tag":"pre","props":{"code":"[Unit]\nDescription=Shadowsocks\nAfter=network.target auditd.service\n\n[Service]\nType=forking\nTimeoutStartSec=0\nExecStart=/usr/local/bin/ssserver -c /etc/shadowsocks.json --pid-file /var/run/shadowsocks.pid -d start\nExecStop=/usr/local/bin/ssserver -c /etc/shadowsocks.json  --pid-file /var/run/shadowsocks.pid -d stop\nPIDFile=/var/run/shadowsocks.pid\nRestart=always\nRestartSec=4\n\n\n[Install]\nWantedBy=multi-user.target\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[Unit]\nDescription=Shadowsocks\nAfter=network.target auditd.service\n\n[Service]\nType=forking\nTimeoutStartSec=0\nExecStart=/usr/local/bin/ssserver -c /etc/shadowsocks.json --pid-file /var/run/shadowsocks.pid -d start\nExecStop=/usr/local/bin/ssserver -c /etc/shadowsocks.json  --pid-file /var/run/shadowsocks.pid -d stop\nPIDFile=/var/run/shadowsocks.pid\nRestart=always\nRestartSec=4\n\n\n[Install]\nWantedBy=multi-user.target\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"执行以下命令启动 shadowsocks 服务："}]},{"type":"element","tag":"pre","props":{"code":"systemctl enable shadowsocks\nsystemctl start shadowsocks\n","language":"bash","meta":"","className":["language-bash"]},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"systemctl enable shadowsocks\nsystemctl start shadowsocks\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"为了检查 shadowsocks 服务是否已成功启动，可以执行以下命令查看服务的状态："}]},{"type":"element","tag":"pre","props":{"code":"systemctl status shadowsocks -l\n","language":"bash","meta":"","className":["language-bash"]},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"systemctl status shadowsocks -l\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果服务启动成功，则控制台显示的信息可能类似这样："}]},{"type":"element","tag":"pre","props":{"code":"● shadowsocks.service - Shadowsocks\n   Loaded: loaded (/etc/systemd/system/shadowsocks.service; enabled; vendor preset: disabled)\n   Active: active (running) since Mon 2015-12-21 23:51:48 CST; 11min ago\n Main PID: 19334 (ssserver)\n   CGroup: /system.slice/shadowsocks.service\n           └─19334 /usr/bin/python /usr/bin/ssserver -c /etc/shadowsocks.json\n\nDec 21 23:51:48 morning.work systemd[1]: Started Shadowsocks.\nDec 21 23:51:48 morning.work systemd[1]: Starting Shadowsocks...\nDec 21 23:51:48 morning.work ssserver[19334]: INFO: loading config from /etc/shadowsocks.json\nDec 21 23:51:48 morning.work ssserver[19334]: 2015-12-21 23:51:48 INFO     loading libcrypto from libcrypto.so.10\nDec 21 23:51:48 morning.work ssserver[19334]: 2015-12-21 23:51:48 INFO     starting server at 0.0.0.0:8388\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"● shadowsocks.service - Shadowsocks\n   Loaded: loaded (/etc/systemd/system/shadowsocks.service; enabled; vendor preset: disabled)\n   Active: active (running) since Mon 2015-12-21 23:51:48 CST; 11min ago\n Main PID: 19334 (ssserver)\n   CGroup: /system.slice/shadowsocks.service\n           └─19334 /usr/bin/python /usr/bin/ssserver -c /etc/shadowsocks.json\n\nDec 21 23:51:48 morning.work systemd[1]: Started Shadowsocks.\nDec 21 23:51:48 morning.work systemd[1]: Starting Shadowsocks...\nDec 21 23:51:48 morning.work ssserver[19334]: INFO: loading config from /etc/shadowsocks.json\nDec 21 23:51:48 morning.work ssserver[19334]: 2015-12-21 23:51:48 INFO     loading libcrypto from libcrypto.so.10\nDec 21 23:51:48 morning.work ssserver[19334]: 2015-12-21 23:51:48 INFO     starting server at 0.0.0.0:8388\n"}]}]},{"type":"element","tag":"h1","props":{"id":"错误"},"children":[{"type":"text","value":"错误"}]},{"type":"element","tag":"pre","props":{"code":"AttributeError: /lib64/libcrypto.so.1.1: undefined symbol: EVP_CIPHER_CTX_cleanup\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"AttributeError: /lib64/libcrypto.so.1.1: undefined symbol: EVP_CIPHER_CTX_cleanup\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"以前在openssl，有"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"EVP_CIPHER_CTX_cleanup"}]},{"type":"text","value":"函数.1.1.0版本中替换成为"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"EVP_CIPHER_CTX_reset"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"解决办法：找到报错的文件(注意:根据你的python版本修改,看报错信息中使用的openssl文件)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"vim /usr/local/lib/python2.7/dist-packages/shadowsocks/crypto/openssl.py"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"全文搜索cleanup将所有"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"EVP_CIPHER_CTX_cleanup"}]},{"type":"text","value":"替换成为"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"EVP_CIPHER_CTX_reset"}]}]},{"type":"element","tag":"pre","props":{"code":":%s/cleanup/reset/\n\n:x\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":":%s/cleanup/reset/\n\n:x\n"}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"安装-pip","depth":2,"text":"安装 pip"},{"id":"安装配置-shadowsocks","depth":2,"text":"安装配置 shadowsocks"},{"id":"客户端","depth":2,"text":"客户端","children":[{"id":"前台运行","depth":3,"text":"前台运行"},{"id":"后台运行","depth":3,"text":"后台运行"}]},{"id":"method-aes-256-gcm-not-supported方法","depth":2,"text":"method aes-256-gcm not supported方法"},{"id":"安装","depth":2,"text":"安装"},{"id":"配置","depth":2,"text":"配置"},{"id":"用法","depth":2,"text":"用法"},{"id":"服务端","depth":2,"text":"服务端"}]}},"_type":"markdown","_id":"content:tool:2020-01-12-centosn-ss-install.md","_source":"content","_file":"tool/2020-01-12-centosn-ss-install.md","_extension":"md","date":"2020-01-12"}