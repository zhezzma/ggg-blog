{"_path":"/tool/2020-03-25-protobuf-empty-collections","_dir":"tool","_draft":false,"_partial":false,"_locale":"","title":"protobuf序列化的一些问题","description":"Each derived class must have its base class marked with [ProtoInclude(, typeof(ProtoBuff-Derived-Class))]. If not, all values will be NULL.","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"base-derived-classes"},"children":[{"type":"text","value":"Base / Derived Classes"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Each derived class must have its base class marked with [ProtoInclude(, typeof(ProtoBuff-Derived-Class))]. If not, all values will be NULL."}]},{"type":"element","tag":"pre","props":{"code":"[ProtoContract]\n[ProtoInclude(100, typeof(HomeFolders))]\n[ProtoInclude(200, typeof(PublicFolders))]\npublic class Folders\n{\n  [ProtoMember(1)]\n  public int ProtoMember1 { get; set; }\n\n  [ProtoMember(2)]\n  public int ProtoMember2 { get; set; }\n}\n\n[ProtoContract]\npublic class HomeFolders : Folders\n{\n  [ProtoMember(1)]\n  public int ProtoMember4 { get; set; }\n}\n\n[ProtoContract]\npublic class PublicFolders : Folders\n{\n  [ProtoMember(1)]\n  public int ProtoMember5 { get; set; }\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[ProtoContract]\n[ProtoInclude(100, typeof(HomeFolders))]\n[ProtoInclude(200, typeof(PublicFolders))]\npublic class Folders\n{\n  [ProtoMember(1)]\n  public int ProtoMember1 { get; set; }\n\n  [ProtoMember(2)]\n  public int ProtoMember2 { get; set; }\n}\n\n[ProtoContract]\npublic class HomeFolders : Folders\n{\n  [ProtoMember(1)]\n  public int ProtoMember4 { get; set; }\n}\n\n[ProtoContract]\npublic class PublicFolders : Folders\n{\n  [ProtoMember(1)]\n  public int ProtoMember5 { get; set; }\n}\n"}]}]},{"type":"element","tag":"h1","props":{"id":"avoid-duplicate-property-tags"},"children":[{"type":"text","value":"Avoid duplicate property tags"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using the same number for ProtoInclude and ProtoMember will generate an error about duplicate property tags. The example below is "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"NOT"}]},{"type":"text","value":" correct."}]},{"type":"element","tag":"pre","props":{"code":"[ProtoContract]\n[ProtoInclude(1, typeof(PublicFolders))]\npublic class Folders\n{\n  [ProtoMember(1)]\n  public int ProtoMember1 { get; set; }\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[ProtoContract]\n[ProtoInclude(1, typeof(PublicFolders))]\npublic class Folders\n{\n  [ProtoMember(1)]\n  public int ProtoMember1 { get; set; }\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"So you need to use a different number for ProtoInclude. Corrected example:"}]},{"type":"element","tag":"pre","props":{"code":"[ProtoContract]\n[ProtoInclude(100, typeof(PublicFolders))]\npublic class Folders\n{\n  [ProtoMember(1)]\n  public int ProtoMember1 { get; set; }\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[ProtoContract]\n[ProtoInclude(100, typeof(PublicFolders))]\npublic class Folders\n{\n  [ProtoMember(1)]\n  public int ProtoMember1 { get; set; }\n}\n"}]}]},{"type":"element","tag":"h1","props":{"id":"null-vs-empty-collections"},"children":[{"type":"text","value":"Null vs. Empty Collections"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ProtoBuf does not understand the difference between a collection (List, IEnumerable etc) being null versus empty (zero count). For example, if you put these objects into the cache,"}]},{"type":"element","tag":"pre","props":{"code":"List<int> list1 = new List<int>();\nList<int> list2 = null;\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"List<int> list1 = new List<int>();\nList<int> list2 = null;\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"after deserialization, both the lists will have the same value—that is NULL. There are two ways to solve this:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Using a private field (we are using this):"},{"type":"element","tag":"pre","props":{"code":"[ProtoMember(12, OverwriteList = true)]\nprivate List _publicFolders;\npublic List publicFolders\n{\n  get\n  {\n    if (_publicFolders == null)\n    {\n      _publicFolders = new List();\n    }\n    return _publicFolders;\n  }\n  set\n  {\n    _publicFolders = value;\n  }\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[ProtoMember(12, OverwriteList = true)]\nprivate List _publicFolders;\npublic List publicFolders\n{\n  get\n  {\n    if (_publicFolders == null)\n    {\n      _publicFolders = new List();\n    }\n    return _publicFolders;\n  }\n  set\n  {\n    _publicFolders = value;\n  }\n}\n"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Using the OnDeserialized attribute:"},{"type":"element","tag":"pre","props":{"code":"[ProtoMember(2, OverwriteList = true)]\nprivate PublicFolder[] publicFolders;\n[ProtoMember(3, OverwriteList = true)]\nprivate PrivateFolder[] privateFolder;\n[ProtoMember(4, OverwriteList = true)]\nprivate SecureFolder[] secureFolder;\n\n[OnDeserialized]\nprivate void HandleSerializationMismatch(StreamingContext context)\n{\n  publicFolders = publicFolders ?? new PublicFolders[0];\n  privateFolder = privateFolder ?? new PrivateFolder[0];\n  secureFolder = secureFolder ?? new SecureFolder[0];\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[ProtoMember(2, OverwriteList = true)]\nprivate PublicFolder[] publicFolders;\n[ProtoMember(3, OverwriteList = true)]\nprivate PrivateFolder[] privateFolder;\n[ProtoMember(4, OverwriteList = true)]\nprivate SecureFolder[] secureFolder;\n\n[OnDeserialized]\nprivate void HandleSerializationMismatch(StreamingContext context)\n{\n  publicFolders = publicFolders ?? new PublicFolders[0];\n  privateFolder = privateFolder ?? new PrivateFolder[0];\n  secureFolder = secureFolder ?? new SecureFolder[0];\n}\n"}]}]}]}]},{"type":"element","tag":"h1","props":{"id":"things-to-remember"},"children":[{"type":"text","value":"Things to Remember"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ProtoBuf ignores properties if the class inherits from a collection and the Items property for that collection is null. Example:"}]},{"type":"element","tag":"pre","props":{"code":"public class Folders : List\n{\n  public int value1 { get; set; }\n\n  public int value2 { get; set; }\n}\n\nFolders folders = new Folders() { value1 = 5; value2 = 6; };\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"public class Folders : List\n{\n  public int value1 { get; set; }\n\n  public int value2 { get; set; }\n}\n\nFolders folders = new Folders() { value1 = 5; value2 = 6; };\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"After deserialization, the value of the Folders object will be NULL, because the count of items on is 0."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Classes that inherit from special collections are also not supported."}]},{"type":"element","tag":"pre","props":{"code":"public class Folders : ReadOnlyCollection\n{\n  public int value1 { get; set; }\n\n  public int value2 { get; set; }\n}\n\nFolders folders = new Folders() { value1 = 5; value2 = 6; };\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"public class Folders : ReadOnlyCollection\n{\n  public int value1 { get; set; }\n\n  public int value2 { get; set; }\n}\n\nFolders folders = new Folders() { value1 = 5; value2 = 6; };\n"}]}]},{"type":"element","tag":"h1","props":{"id":"allowparseabletypes"},"children":[{"type":"text","value":"AllowParseableTypes"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"AllowParseableTypes is a global switch that determines whether types with “.ToString()” and “Parse(string)” methods should be serialized as strings. We can use this setting for types that can’t be marked in the ProtoContract but can be parseable."}]},{"type":"element","tag":"pre","props":{"code":"static ProtoBufClient()\n{\n  RuntimeTypeModel.Default.AllowParseableTypes = true;\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"static ProtoBufClient()\n{\n  RuntimeTypeModel.Default.AllowParseableTypes = true;\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For example, to solve the serialization problem with the Version type:"}]},{"type":"element","tag":"pre","props":{"code":"[Serializable]\n[ProtoContract(SkipConstructor = true)]\n[ProtoInclude(100, typeof(PrivateFolder))]\n[ProtoInclude(200, typeof(PublicFolder))]\n[ProtoInclude(300, typeof(SecureFolder))]\npublic abstract class FolderBase : Folder\n{\n  ...\n\n  [ProtoMember(3)]\n  private string name;\n  [ProtoMember(4)]\n  private Owner owner;\n\n  ...\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[Serializable]\n[ProtoContract(SkipConstructor = true)]\n[ProtoInclude(100, typeof(PrivateFolder))]\n[ProtoInclude(200, typeof(PublicFolder))]\n[ProtoInclude(300, typeof(SecureFolder))]\npublic abstract class FolderBase : Folder\n{\n  ...\n\n  [ProtoMember(3)]\n  private string name;\n  [ProtoMember(4)]\n  private Owner owner;\n\n  ...\n}\n"}]}]},{"type":"element","tag":"h1","props":{"id":"protobuf-net-generics-on-unity3d-il2cpp"},"children":[{"type":"text","value":"Protobuf-net Generics on Unity3D IL2CPP."}]},{"type":"element","tag":"pre","props":{"code":"public class CustomCollectionBase<TCollection, TElement, TKey>\n{\n    protected TCollection _collection;\n\n    protected SortedDictionary<TKey, bool> _removed;\n\n    public CustomCollectionBase(TCollection collection)\n    {\n        _collection = collection;\n    }\n\n    protected byte[] _cBytes;\n\n    protected byte[] _rBytes;\n\n    protected void __PreSerialize()\n    {\n        using (MemoryStream stream = new MemoryStream())\n        {\n            Serializer.Serialize(stream, this._collection);\n            this._cBytes = stream.ToArray();\n        }\n\n        using (MemoryStream stream = new MemoryStream())\n        {\n            Serializer.Serialize(stream, this._removed);\n            this._rBytes = stream.ToArray();\n        }\n    }\n\n    protected void __PostDeserialize()\n    {\n        using (MemoryStream stream = new MemoryStream(this._cBytes))\n        {\n            this._collection = Serializer.Deserialize<TCollection>(stream);\n        }\n\n        using (MemoryStream stream = new MemoryStream(this._rBytes))\n        {\n            this._removed = Serializer.Deserialize<SortedDictionary<TKey, bool>>(stream);\n        }\n    }\n}\n\n[ProtoContract]\npublic class CustomList<TElement> : CustomCollectionBase<List<TElement>, TElement, int>\n{\n    public CustomList() : base( new List<TElement>())\n    {\n    }\n\n    [ProtoMember(1)]\n    private byte[] _cProto\n    {\n        get { return base._cBytes; }\n        set { base._cBytes = value; }\n    }\n\n    [ProtoMember(2)]\n    private byte[] _rProto\n    {\n        get { return base._rBytes; }\n        set { base._rBytes = value; }\n    }\n\n    [ProtoBeforeSerialization]\n    private void __PreSerialize()\n    {\n        base.__PreSerialize();\n    }\n\n    [ProtoAfterDeserialization]\n    private void __PostDeserialize()\n    {\n        base.__PostDeserialize();\n    }\n}\n\n[ProtoContract]\npublic class CustomIntDictionary<TElement> : CustomCollectionBase<Dictionary<int, TElement>, TElement, int>\n{\n    public CustomIntDictionary() : base(new Dictionary<int, TElement>())\n    {\n    }\n\n    [ProtoMember(1)]\n    private byte[] _cProto\n    {\n        get { return base._cBytes; }\n        set { base._cBytes = value; }\n    }\n\n    [ProtoMember(2)]\n    private byte[] _rProto\n    {\n        get { return base._rBytes; }\n        set { base._rBytes = value; }\n    }\n\n    [ProtoBeforeSerialization]\n    private void __PreSerialize()\n    {\n        base.__PreSerialize();\n    }\n\n    [ProtoAfterDeserialization]\n    private void __PostDeserialize()\n    {\n        base.__PostDeserialize();\n    }\n}\n\n[ProtoContract]\npublic class CustomStringDictionary<TElement> : CustomCollectionBase<Dictionary<string, TElement>, TElement, string>\n{\n    public CustomStringDictionary() : base(new Dictionary<string, TElement>())\n    {\n    }\n\n    [ProtoMember(1)]\n    private byte[] _cProto\n    {\n        get { return base._cBytes; }\n        set { base._cBytes = value; }\n    }\n\n    [ProtoMember(2)]\n    private byte[] _rProto\n    {\n        get { return base._rBytes; }\n        set { base._rBytes = value; }\n    }\n\n    [ProtoBeforeSerialization]\n    private void __PreSerialize()\n    {\n        base.__PreSerialize();\n    }\n\n    [ProtoAfterDeserialization]\n    private void __PostDeserialize()\n    {\n        base.__PostDeserialize();\n    }\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"public class CustomCollectionBase<TCollection, TElement, TKey>\n{\n    protected TCollection _collection;\n\n    protected SortedDictionary<TKey, bool> _removed;\n\n    public CustomCollectionBase(TCollection collection)\n    {\n        _collection = collection;\n    }\n\n    protected byte[] _cBytes;\n\n    protected byte[] _rBytes;\n\n    protected void __PreSerialize()\n    {\n        using (MemoryStream stream = new MemoryStream())\n        {\n            Serializer.Serialize(stream, this._collection);\n            this._cBytes = stream.ToArray();\n        }\n\n        using (MemoryStream stream = new MemoryStream())\n        {\n            Serializer.Serialize(stream, this._removed);\n            this._rBytes = stream.ToArray();\n        }\n    }\n\n    protected void __PostDeserialize()\n    {\n        using (MemoryStream stream = new MemoryStream(this._cBytes))\n        {\n            this._collection = Serializer.Deserialize<TCollection>(stream);\n        }\n\n        using (MemoryStream stream = new MemoryStream(this._rBytes))\n        {\n            this._removed = Serializer.Deserialize<SortedDictionary<TKey, bool>>(stream);\n        }\n    }\n}\n\n[ProtoContract]\npublic class CustomList<TElement> : CustomCollectionBase<List<TElement>, TElement, int>\n{\n    public CustomList() : base( new List<TElement>())\n    {\n    }\n\n    [ProtoMember(1)]\n    private byte[] _cProto\n    {\n        get { return base._cBytes; }\n        set { base._cBytes = value; }\n    }\n\n    [ProtoMember(2)]\n    private byte[] _rProto\n    {\n        get { return base._rBytes; }\n        set { base._rBytes = value; }\n    }\n\n    [ProtoBeforeSerialization]\n    private void __PreSerialize()\n    {\n        base.__PreSerialize();\n    }\n\n    [ProtoAfterDeserialization]\n    private void __PostDeserialize()\n    {\n        base.__PostDeserialize();\n    }\n}\n\n[ProtoContract]\npublic class CustomIntDictionary<TElement> : CustomCollectionBase<Dictionary<int, TElement>, TElement, int>\n{\n    public CustomIntDictionary() : base(new Dictionary<int, TElement>())\n    {\n    }\n\n    [ProtoMember(1)]\n    private byte[] _cProto\n    {\n        get { return base._cBytes; }\n        set { base._cBytes = value; }\n    }\n\n    [ProtoMember(2)]\n    private byte[] _rProto\n    {\n        get { return base._rBytes; }\n        set { base._rBytes = value; }\n    }\n\n    [ProtoBeforeSerialization]\n    private void __PreSerialize()\n    {\n        base.__PreSerialize();\n    }\n\n    [ProtoAfterDeserialization]\n    private void __PostDeserialize()\n    {\n        base.__PostDeserialize();\n    }\n}\n\n[ProtoContract]\npublic class CustomStringDictionary<TElement> : CustomCollectionBase<Dictionary<string, TElement>, TElement, string>\n{\n    public CustomStringDictionary() : base(new Dictionary<string, TElement>())\n    {\n    }\n\n    [ProtoMember(1)]\n    private byte[] _cProto\n    {\n        get { return base._cBytes; }\n        set { base._cBytes = value; }\n    }\n\n    [ProtoMember(2)]\n    private byte[] _rProto\n    {\n        get { return base._rBytes; }\n        set { base._rBytes = value; }\n    }\n\n    [ProtoBeforeSerialization]\n    private void __PreSerialize()\n    {\n        base.__PreSerialize();\n    }\n\n    [ProtoAfterDeserialization]\n    private void __PostDeserialize()\n    {\n        base.__PostDeserialize();\n    }\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"So basically there are two methods that are defined."}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"__PreSerialize – Converts the collection in to a byte array which becomes the proto member."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"__PostDeserialize – Converts the byte array back to the collection."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can completely avoid defining run time types for this generic type. Instead of protobuf-net being responsible of creating the type, we create the type by ourselves using the same protobuf Serializer."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This kind of technique can be used for other generic types as well. Please comment your ideas about this approach."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:tool:2020-03-25-protobuf-Empty-Collections.md","_source":"content","_file":"tool/2020-03-25-protobuf-Empty-Collections.md","_extension":"md","date":"2020-03-25"}